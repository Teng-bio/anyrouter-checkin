# AnyRouter + RunAnytime 工作手册

更新时间：2026-02-24  
适用目录：`/home/teng/anyrouter/anyrouter-checkin`

## 1. 目标

用一套脚本同时完成两类账号签到：

1. AnyRouter（用户名/密码登录）
2. RunAnyTime（LinuxDo OAuth 登录，依赖已保存登录态）

并支持日常手动执行、定时自动执行、故障快速恢复。

## 2. 关键文件

- `checkin_playwright.py`：主程序
- `config/batch1.json`：当前主批次配置（已包含 AnyRouter + runanytime）
- `config/runanytime_linuxdo.json`：RunAnyTime 单独调试配置
- `config/states/runanytime_oauth.json`：RunAnyTime 登录态缓存（首次授权后生成）
- `logs/checkin_YYYYMMDD.log`：每日运行日志
- `reports/`：签到结果与令牌报告

## 3. 一次性初始化（新机器或环境重建时）

1. 进入环境

```bash
cd /home/teng/anyrouter/anyrouter-checkin
conda activate anyrouter
```

2. 安装依赖（仅首次）

```bash
python -m pip install -r requirements.txt
python -m pip install playwright
python -m playwright install chromium
```

3. 验证环境

```bash
python -c "import playwright; print('playwright ok')"
python checkin_playwright.py --help
```

## 4. 首次准备 RunAnyTime 登录态（LinuxDo 授权）

说明：

1. 这一步只做授权，不做日常签到。
2. 需要可视化浏览器。
3. 需要手动通过 Cloudflare 人机验证并完成 LinuxDo 授权。

执行命令：

```bash
python checkin_playwright.py -c config/runanytime_linuxdo.json --prepare-linuxdo --account runanytime_oauth
```

完成后确认文件存在：

```bash
ls -l config/states/runanytime_oauth.json
```

如果该文件存在，后续就可无头自动执行。

## 5. 日常运行流程

### 5.1 先跑单账号自检（推荐）

```bash
python checkin_playwright.py -c config/batch1.json --account runanytime_oauth
python checkin_playwright.py -c config/batch1.json --account ghx
```

### 5.2 跑整批（AnyRouter + RunAnyTime 一起）

```bash
python checkin_playwright.py -c config/batch1.json
```

说明：`config/batch1.json` 已包含 `runanytime_oauth`，不需要额外拼接命令。

## 6. 定时自动运行（Cron）

编辑任务：

```bash
crontab -e
```

建议保留以下任务（示例）：

```bash
# 每天 09:00 执行主批次（包含 AnyRouter + RunAnyTime）
0 9 * * * cd /home/teng/anyrouter/anyrouter-checkin && /home/teng/anaconda3/envs/anyrouter/bin/python checkin_playwright.py -c config/batch1.json >> logs/batch1.log 2>&1

# 如需保留第二批
0 20 * * * cd /home/teng/anyrouter/anyrouter-checkin && /home/teng/anaconda3/envs/anyrouter/bin/python checkin_playwright.py -c config/batch2.json >> logs/batch2.log 2>&1
```

检查是否生效：

```bash
crontab -l
tail -n 100 logs/batch1.log
```

## 7. 故障处理 SOP

### 7.1 `ModuleNotFoundError: No module named 'playwright'`

```bash
conda activate anyrouter
python -m pip install playwright
python -m playwright install chromium
```

### 7.2 `配置文件不存在`

检查路径是否在项目目录下，命令是否写成：

```bash
python checkin_playwright.py -c config/batch1.json
```

### 7.3 RunAnyTime 登录失效（登录态过期）

现象：

1. 无法复用已有登录态
2. 提示需要重新授权

处理：

```bash
python checkin_playwright.py -c config/runanytime_linuxdo.json --prepare-linuxdo --account runanytime_oauth
```

### 7.4 签到按钮不可点（`disabled`）

这通常是“今日已签到”。脚本已兼容：

1. 按钮不可点击时会自动判断已签到或改走 API 检查
2. 已签到会按成功处理，不应再记为失败

### 7.5 `令牌数据结构无法识别`

这是不同站点返回格式差异导致的警告。  
不影响签到主流程，只影响令牌展示/报表细节。

### 7.6 `BrowserType.launch: Target page, context or browser has been closed`

常见于无图形环境或浏览器进程被系统关闭。  
优先在可视化桌面会话中重试，或切回 `headless: true` 的定时模式。

### 7.7 Cloudflare 一直卡验证（改用已打开浏览器）

先关闭所有 Chrome，再用调试端口启动：

```bash
/usr/bin/google-chrome --remote-debugging-port=9222 --user-data-dir=/tmp/chrome-cdp-anyrouter
```

然后让脚本连接这个浏览器做授权：

```bash
python checkin_playwright.py -c config/linuxdo_prepare.json --prepare-linuxdo --account elysiver_oauth --cdp-url http://127.0.0.1:9222
```

说明：

1. `--cdp-url` 模式会复用该浏览器会话，不再由脚本另起浏览器实例。
2. 若要授权其他站点，把 `--account` 换成对应账号标签。

## 8. 配置变更规范

1. AnyRouter 账号继续放在 `config/batch1.json` 的普通账号项中（`username/password`）。
2. RunAnyTime 账号保持 `site.auth_mode = linuxdo`。
3. 每个 LinuxDo 账号使用独立 `storage_state_path`，避免串号。
4. 变更后先做单账号验证，再跑整批。

## 9. 安全与维护建议

1. `config/*.json`、`reports/*.json` 里可能含敏感信息，避免外发。
2. 每周至少检查一次 `logs/checkin_YYYYMMDD.log`。
3. 每月备份一次 `config/states/`，避免状态文件丢失。

## 10. 最短执行清单

1. `cd /home/teng/anyrouter/anyrouter-checkin`
2. `conda activate anyrouter`
3. `python checkin_playwright.py -c config/batch1.json`
4. 看结果：`tail -n 100 logs/checkin_$(date +%Y%m%d).log`

## 11. GitHub 上传流程

只上传代码和文档，不上传运行态文件（截图、报告、登录态）。

1. 查看变更

```bash
git status
```

2. 选择性提交（示例）

```bash
git add README.md checkin_playwright.py config/accounts.example.json config/batch1.json config/linuxdo_prepare.json config/runanytime_linuxdo.json 工作手册.md 工作进度.md .gitignore
git commit -m "feat: add multi-site linuxdo workflow and docs"
```

3. 推送到远程仓库

```bash
git push origin main
```

4. 推送后检查

```bash
git log --oneline -n 3
git status
```
